# 等待时间分布实验报告模板
## 1. 实验概述
### 1.1 实验背景
在随机过程中，等待时间分布是一个重要的研究课题。本实验通过抛硬币模型，研究了稀有事件（硬币正面）出现之间的等待时间分布特性。当正面朝上概率较小（p=0.08）时，正面出现的过程可以看作是一个泊松过程，我们关注两次正面之间出现的反面次数的概率分布。

### 1.2 实验目的
- 理解稀有事件的等待时间分布特性
- 掌握随机序列的生成与分析方法
- 通过可视化和统计分析验证理论分布模型
## 2. 实验方法
### 2.1 实验原理
在抛硬币实验中，每次抛掷是独立的伯努利试验，正面概率为p=0.08。两次正面之间的等待时间（即中间出现的反面次数）理论上应该服从几何分布，其概率质量函数为：

P(X = k) = (1-p)^k * p

其中k是等待时间（反面次数）。几何分布的理论均值为(1-p)/p。

从连续时间角度看，等待时间也可以用指数分布描述，其理论均值为1/p。

### 2.2 实验步骤
1. 生成硬币序列（1表示正面，0表示反面）
2. 计算两次正面之间的等待时间
3. 绘制等待时间直方图（普通坐标和半对数坐标）
4. 分析等待时间的统计特性
5. 比较不同样本量下的结果
### 2.3 实验代码实现
简要描述代码实现的主要函数和方法：

- generate_coin_sequence : 生成硬币序列
- calculate_waiting_times : 计算等待时间
- plot_waiting_time_histogram : 绘制直方图
- analyze_waiting_time : 分析统计特性
## 3. 实验结果与分析
### 3.1 小样本实验（1000次抛掷） 
#### 3.1.1 等待时间分布直方图
<img width="443" alt="image" src="https://github.com/user-attachments/assets/c4e76a3f-73e1-464a-bfe5-4cb77af7c953" />

#### 3.1.2 半对数坐标下的分布
<img width="435" alt="image" src="https://github.com/user-attachments/assets/36c39d1e-a203-44fe-bf43-8a053d97c842" />

 #### 3.1.3 统计分析
- 实验平均等待时间：[11.78]
- 理论平均等待时间（几何分布）：[11.50]
- 理论平均等待时间（指数分布）：[12.50]
- 标准差：[13.20] 
#### 3.1.4 分布特性分析
根据半对数坐标图的特征（是否呈现直线），分析等待时间是否符合几何分布/指数分布的特性。
半对数坐标图显示近似直线关系，验证了等待时间服从指数分布的特性。小样本下实验均值（11.78）与几何分布理论值（11.5）接近，但存在约3%的偏差。
### 3.2 大样本实验（1000000次抛掷） 
#### 3.2.1 等待时间分布直方图
<img width="458" alt="image" src="https://github.com/user-attachments/assets/d3545e05-0f5c-4e63-83c9-d3dbc7cde964" />

#### 3.2.2 半对数坐标下的分布
<img width="453" alt="image" src="https://github.com/user-attachments/assets/f77d3326-7310-45c6-acd3-361f3cd1cb4f" />

#### 3.2.3 统计分析
- 实验平均等待时间：[11.47]
- 理论平均等待时间（几何分布）：[11.5]
- 理论平均等待时间（指数分布）：[12.5]
- 标准差：[11.97] 
#### 3.2.4 分布特性分析
分析大样本下分布的特性，与理论分布的拟合程度。
大样本下实验均值（11.47）与理论值（11.5）几乎完全吻合，半对数坐标的直线特征更加明显。分布尾部更接近理论曲线，验证了大数定律.
### 3.3 样本量对结果的影响
比较小样本和大样本实验结果的差异：

- 分布形状的变化
- ### 样本量对分布特征的影响

| 特征               | 小样本 (1000次)       | 大样本 (100万次)      |
|--------------------|-----------------------|-----------------------|
| **分布曲线平滑度**  | 锯齿状明显             | 光滑连续              |
| **尾部衰减**        | 截断较早               | 完整呈现长尾特征      |
| **峰值高度稳定性**  | 波动较大               | 稳定                 |
| **极端值捕获能力**  | 最大等待时间≤60        | 最大等待时间≥120      |
| **模态数量**        | 可能出现多峰           | 严格单峰              |


**关键说明**：
1. 平滑度差异源于大样本更好地满足中心极限定理
2. 长尾特征需要至少10^5量级样本才能完整呈现
3. 峰值波动率 = (实测峰值-理论峰值)/理论峰值
- 实验均值与理论均值的接近程度
- 理论均值 = (1-p)/p = 11.5 (p=0.08)
# 实验结果对比
          均值    误差率
小样本    11.78    +2.4%  
大样本    11.47   -0.026%
大样本更接近
- 分布拟合的精确度
- ![Figure_1](https://github.com/user-attachments/assets/79a1e8cb-b863-4f81-b978-f924b22cb429)
  ![Figure_2](https://github.com/user-attachments/assets/dc9047ab-265a-464e-9d2a-535256e7d44c)
开始实验：1,000次抛掷 (p=0.08)

统计结果：
- 有效等待时间数量: 78
- 实验均值: 11.782 (理论: 11.500)
- 均值偏差: 2.45%
- K-S检验: D=0.1779, p=0.0124

- 开始实验：1,000,000次抛掷 (p=0.08)

统计结果：
- 有效等待时间数量: 80,198
- 实验均值: 11.469 (理论: 11.500)
- 均值偏差: 0.27%
- K-S检验: D=0.0798, p=0.0000

- 实验对比总结：
指标                   小样本(1000)       大样本(100万)
均值偏差率(%)             2.45           0.27
K-S检验D值              0.1779           0.0798
K-S检验p值              0.0124           0.0000
由此可见，大样本精确度更高
## 4. 讨论与结论
### 4.1 实验结果总结
总结等待时间分布的主要特性和规律。
等待时间分布呈现典型指数衰减特征

大样本下实验数据与理论预测高度吻合

半对数坐标的线性关系验证了泊松过程的特性
### 4.2 理论解释
从概率论角度解释观察到的分布特性：
- 为什么等待时间符合几何分布/指数分布
- 半对数坐标下呈现直线的数学原理
几何分布特性：每次抛掷都是独立事件，符合无记忆性

半对数直线：反映P(X=k) = (1-p)^k * p的指数关系

均值收敛：大数定律保证样本均值趋近理论期望
### 4.3 实验局限性
讨论实验可能存在的局限性和改进方向。
伪随机数生成器的周期性影响

极端稀有事件（长等待时间）采样不足

离散分布与连续近似的误差
# 实验局限性分析与改进方案

## 1. 伪随机数生成器的周期性影响

### 问题本质
Python默认的Mersenne Twister算法（周期$2^{19937}-1$）在极端大规模模拟中仍可能出现周期性重复

### 改进方案

| 方法                | 实施步骤                                                                 | 优点                     | 缺点                     |
|---------------------|--------------------------------------------------------------------------|--------------------------|--------------------------|
| **密码学安全RNG**   | `import secrets; secrets.randbelow()`                                    | 无周期性                 | 速度慢(约慢100倍)        |
| **硬件熵源**        | 使用`numpy.random.Generator(PCG64)`                                      | 高随机性                 | 需现代CPU支持            |
| **多算法混合**      | 结合Xoshiro256++和ChaCha20算法                                           | 平衡速度与质量           | 实现复杂                 |

```python
# 示例代码
from numpy.random import Generator, PCG64
rng = Generator(PCG64(seed=42))
data = rng.geometric(p=0.08, size=1000000) - 1
```
## 2. 极端稀有事件（长等待时间）采样不足

### 问题本质
当事件概率$p=0.08$时，长等待时间的理论概率：
$$ P(X>100) \approx (1-0.08)^{100} \approx 2.2 \times 10^{-9} $$
常规百万次($10^6$)模拟中预期仅能捕获约0.002次此类事件

### 改进方案

| 方法                | 数学原理                                                                 | 实现方式                                                                 | 效果评估               |
|---------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|------------------------|
| **重要性采样**      | 使用偏置分布$q>p$提高稀有事件频率，权重修正：<br>$w(x) = \frac{P_{true}(x)}{P_{bias}(x)}$ | ```python<br>q = 0.15  # 偏置概率<br>samples = np.random.geometric(q)-1<br>weights = (0.92**samples*0.08)/(0.85**samples*0.15)``` | 方差减少30-50%        |
| **分层抽样**        | 将样本空间划分为$k$个 strata：<br>$S_1=[0,10),...,S_k=[100,\infty)$       | ```python<br>strata_counts = [int(n*P(X∈S_i)) for S_i in strata]```      | 确保每层都有代表样本   |
| **马尔可夫链蒙特卡洛** | 构建转移矩阵$T_{ij}$满足细致平衡条件：<br>$\pi_i T_{ij} = \pi_j T_{ji}$  | ```python<br>def transition(x):<br>    return x+1 if random()<0.1 else max(x-1,0)``` | 适合高维复杂分布       |

### 实施建议
1. 组合使用重要性采样+MCMC
2. 对$X>50$的样本单独建立极值模型
3. 采用自适应采样策略：
   ```python
   while len(rare_events)<100:
       x = simulate()
       if x > threshold: 
           rare_events.append(x)
## 3. 离散分布与连续近似的误差分析与改进方案

### 误差来源分析
对于几何分布 $Geom(p)$ 与指数分布 $Exp(\lambda)$ 的近似（其中 $\lambda = p$）存在三类误差：

1. **离散化误差**  
   $$ \epsilon_d = \sup_k \left| \sum_{i=0}^k p(1-p)^i - \int_0^k \lambda e^{-\lambda x}dx \right| $$

2. **尾部截断误差**  
   当 $k > \frac{2\log n}{p}$ 时，$P(X=k) < n^{-2}$ 在 $n$ 次实验中可能未被采样

3. **统计检验误差**  
   传统K-S检验对离散分布的p值计算偏差可达：
   $$ \Delta p \approx \frac{0.5}{\sqrt{n}} $$

### 改进方案对比

| 方法 | 数学原理 | 实现代码 | 适用场景 |
|------|----------|----------|----------|
| **连续性修正** | 采用中点近似：<br>$F_{corr}(k) = F_{exp}(k+0.5)$ | ```python<br>def cont_correction(k, p):<br>    return 1 - np.exp(-p*(k+0.5))``` | 假设检验 |
| **精确离散检验** | 修正统计量计算：<br>$D_n^* = D_n - \frac{0.5}{n}$ | ```python<br>def discrete_ks(data, p):<br>    d = ks_1samp(data, lambda x: 1-(1-p)**x)<br>    return d - 0.5/len(data)``` | 小样本检验 |
| **混合模型** | 分段建模：<br>$f(x)=\begin{cases}<br>P_{geom}(x) & x \leq x_0 \\<br>P_{exp}(x) & x > x_0<br>\end{cases}$ | ```python<br>def hybrid_model(x, p, x0):<br>    if x <= x0: return p*(1-p)**x<br>    else: return p*np.exp(-p*(x-x0))``` | 大数据分析 |

### 实施案例：连续性修正的完整流程

1. **概率计算修正**
   ```python
   def corrected_prob(k, p):
       return np.exp(-p*(k-0.5)) - np.exp(-p*(k+0.5))
### 4.4 结论
总结实验的主要发现和意义。
实验验证了：

稀有事件等待时间服从几何/指数分布

样本量≥10^6时，实验误差<1%

半对数坐标是验证指数分布的有效工具
## 5. 参考资料
1. Matplotlib Visualization Guidelines
2. https://chat.deepseek.com/a/chat/s/8c8b6858-7fb3-4fe0-8230-5ef861a748ae
